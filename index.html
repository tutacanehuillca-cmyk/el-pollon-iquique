<!doctype html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PollerÃ­a El PollÃ³n - Iquique</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- =================== FIREBASE (BASE DE DATOS EN LÃNEA) =================== -->
  <!-- VersiÃ³n 8.x para usar la API global "firebase" -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <!-- Dejamos Realtime Database cargado (por compatibilidad), aunque ahora usamos Firestore -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- Firestore (aquÃ­ es donde realmente guardaremos los pedidos) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <!-- ======================================================================== -->

  <style>
    body{box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;padding-bottom:100px}
    .category-btn{transition:.3s}
    .category-btn:hover{transform:translateY(-2px)}
    .product-card{transition:.3s}
    .product-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.15)}
    .scrollbar-hide{-ms-overflow-style:none;scrollbar-width:none}
    .scrollbar-hide::-webkit-scrollbar{display:none}
    .cart-badge{animation:pulse .5s ease}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
    .floating-cart{position:fixed;bottom:20px;right:20px;z-index:999;box-shadow:0 8px 24px rgba(0,0,0,.3);animation:float 3s ease-in-out infinite}
    @media (max-width:768px){.floating-cart{bottom:10px;right:10px;left:10px;padding:12px 16px}.floating-cart>div{justify-content:space-between}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;overflow-y:auto}
    .modal.active{display:flex;align-items:center;justify-content:center}
    .toast{position:fixed;bottom:100px;right:20px;background:#10b981;color:#fff;padding:16px 24px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:2000;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .logo-container{width:120px;height:120px;background:#fff;border-radius:50%;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,.2);display:flex;align-items:center;justify-content:center;overflow:hidden}
    .product-image{width:100%;height:200px;object-fit:cover}

    /* === CHATBOT VIRTUAL WHATSAPP === */
    .chatbot-toggle{
      position:fixed;
      left:16px;
      bottom:110px;
      z-index:950;
      background:#22c55e;
      color:#fff;
      padding:10px 16px;
      border-radius:999px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 8px 20px rgba(0,0,0,.3);
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .chatbot-panel{
      position:fixed;
      left:16px;
      bottom:110px;
      width:320px;
      max-height:420px;
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);
      z-index:960;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .chatbot-header{
      background:linear-gradient(135deg,#22c55e 0%,#16a34a 100%);
      color:#fff;
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .chatbot-header-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .chatbot-avatar{
      width:32px;
      height:32px;
      border-radius:50%;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
    }
    .chatbot-body{
      padding:10px;
      flex:1;
      overflow-y:auto;
      background:#f3f4f6;
    }
    .chatbot-msg{
      max-width:90%;
      padding:8px 10px;
      border-radius:12px;
      font-size:13px;
      margin-bottom:6px;
      line-height:1.4;
    }
    .chatbot-msg-bot{
      background:#ffffff;
      border-radius:12px 12px 12px 4px;
      align-self:flex-start;
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    .chatbot-msg-user{
      background:#22c55e;
      color:#fff;
      border-radius:12px 12px 4px 12px;
      align-self:flex-end;
      box-shadow:0 2px 4px rgba(0,0,0,.15);
    }
    .chatbot-quick-actions{
      padding:8px 10px 10px;
      border-top:1px solid #e5e7eb;
      background:#ffffff;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chatbot-chip{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #22c55e;
      color:#166534;
      background:#ecfdf3;
      cursor:pointer;
      white-space:nowrap;
    }

    /* === BOTÃ“N ADMIN (ESTÃTICO) === */
    #admin-open-btn{
      background:linear-gradient(135deg,#111827 0%,#4b5563 100%);
      color:#f9fafb;
      padding:8px 14px;
      border-radius:999px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 4px 12px rgba(0,0,0,.3);
      cursor:pointer;
      font-weight:600;
    }

    /* === MODAL ADMIN === */
    .admin-badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      font-weight:600;
      display:inline-block;
    }
    .admin-badge-pendiente{
      background:#fef3c7;
      color:#92400e;
    }
    .admin-badge-preparacion{
      background:#e0f2fe;
      color:#1d4ed8;
    }
    .admin-badge-entregado{
      background:#dcfce7;
      color:#166534;
    }
    .admin-badge-cancelado{
      background:#fee2e2;
      color:#b91c1c;
    }
    .admin-stat-card{
      border-radius:12px;
      padding:10px 12px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
    }
    .admin-stat-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:#6b7280;
      margin-bottom:4px;
    }
    .admin-stat-value{
      font-size:18px;
      font-weight:700;
      color:#111827;
    }
    @media(max-width:640px){
      .chatbot-panel{ width:260px; }
    }
  </style>
</head>
<body class="bg-white">
  <!-- Header -->
  <header class="text-white py-4 px-4 sticky top-0 z-50" style="background:linear-gradient(135deg,#dc2626 0%,#991b1b 100%);box-shadow:0 4px 6px rgba(0,0,0,.1);">
    <div class="max-w-7xl mx-auto">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <!-- LOGO -->
          <div class="logo-container" style="width:60px;height:60px;">
            <img 
              src="img/logo.png" 
              alt="Logo temporal PollerÃ­a El PollÃ³n" 
              style="width:100%;height:100%;object-fit:cover;border-radius:50%;">
          </div>
          <div class="hidden md:block">
            <h1 class="text-2xl font-bold">PollerÃ­a El PollÃ³n</h1>
            <p class="text-sm opacity-90">ğŸ“ Iquique</p>
          </div>
        </div>
        <div class="hidden lg:flex items-center gap-4">
          <div class="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-lg">
            <span>ğŸ“</span>
            <div>
              <p class="text-xs opacity-75">LlÃ¡manos</p>
              <p class="font-bold text-sm">+56 9 8692 5310</p>
            </div>
          </div>
          <button id="view-cart-desktop" class="bg-yellow-400 text-red-900 px-6 py-3 rounded-lg font-bold hover:bg-yellow-300 transition flex items-center gap-2">
            <span>ğŸ›’</span><span>Ver Mi Pedido</span>
            <span id="cart-badge-desktop" class="bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">0</span>
          </button>
        </div>
        <button id="hamburger-btn" class="lg:hidden text-white p-2 hover:bg-white/20 rounded-lg transition">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- Sidebar -->
  <div id="sidebar-menu" class="fixed top-0 left-0 h-full w-80 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 z-[60] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-red-600">
        <h2 class="text-2xl font-bold text-red-800">ğŸ“‹ MenÃº</h2>
        <button id="close-sidebar" class="text-gray-500 hover:text-red-600 transition">
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <button id="view-cart-mobile" class="w-full bg-yellow-400 text-red-900 px-6 py-4 rounded-lg font-bold hover:bg-yellow-300 transition mb-6 flex items-center justify-between">
        <span class="flex items-center gap-2"><span class="text-2xl">ğŸ›’</span><span>Ver Mi Pedido</span></span>
        <span id="cart-badge-mobile" class="bg-red-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold">0</span>
      </button>

      <div class="space-y-3">
        <h3 class="text-lg font-bold text-gray-700 mb-3">ğŸ½ï¸ CategorÃ­as</h3>
        <button class="sidebar-category w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 transition flex items-center gap-3 border-2 border-transparent hover:border-red-600" data-category="ofertas-familiares">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ofertas Familiares</button>
        <button class="sidebar-category w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 transition flex items-center gap-3 border-2 border-transparent hover:border-red-600" data-category="ofertas-dos">ğŸ‘« Ofertas para Dos</button>
        <button class="sidebar-category w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 transition flex items-center gap-3 border-2 border-transparent hover:border-red-600" data-category="ofertas-personales">ğŸ§‘ Ofertas Personales</button>
        <button class="sidebar-category w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 transition flex items-center gap-3 border-2 border-transparent hover:border-red-600" data-category="platos-extras">ğŸ½ï¸ Platos Extras</button>
        <button class="sidebar-category w-full text-left px-4 py-3 rounded-lg hover:bg-red-50 transition flex items-center gap-3 border-2 border-transparent hover:border-red-600" data-category="agregados">â• Agregados</button>
      </div>

      <div class="mt-8 pt-6 border-t-2 border-gray-200 text-sm text-gray-600 space-y-2">
        <p class="flex items-center gap-2"><span>ğŸ“±</span><span>+56 9 8692 5310</span></p>
        <p class="flex items-center gap-2"><span>ğŸ“</span><span>Calle Vivar 1086, Iquique</span></p>
        <p class="flex items-center gap-2"><span>ğŸ•</span><span>Lun-Dom: 11:30 - 23:00</span></p>
      </div>
    </div>
  </div>
  <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[55] hidden"></div>

  <!-- Banner -->
  <section class="py-0 px-0">
    <div class="relative overflow-hidden" style="height:400px;">
      <div id="carousel-container" class="flex transition-transform duration-1000 ease-in-out h-full">
        <img class="min-w-full h-full object-cover" src="img/porcion de fideo.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/chuleta de cerdo.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/lomo saltado de pollo con arroz blanco.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/oferton sin ensalada.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/chaufa brasa.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/bistec a lo pobre.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/oferton con fideo.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/pechuga a la plancha.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/tallarin saltado de carne.png" alt="">
        <img class="min-w-full h-full object-cover" src="img/oferton mas chaufa.png" alt="">
      </div>
    </div>
  </section>

  <!-- MenÃº -->
  <section class="py-8 px-4 bg-gray-50" style="box-shadow:0 4px 6px rgba(0,0,0,.05);">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-4xl font-bold text-center mb-8 text-red-800">ğŸ½ï¸ Nuestro MenÃº</h2>
      <div class="mb-8 overflow-x-auto scrollbar-hide">
        <div class="flex lg:flex-wrap lg:justify-center gap-4 min-w-max lg:min-w-0 px-2 lg:px-0">
          <button class="category-btn bg-red-600 text-white px-6 py-3 rounded-full font-bold hover:bg-red-700 whitespace-nowrap flex-shrink-0" data-category="ofertas-familiares">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ofertas Familiares</button>
          <button class="category-btn bg-red-600 text-white px-6 py-3 rounded-full font-bold hover:bg-red-700 whitespace-nowrap flex-shrink-0" data-category="ofertas-dos">ğŸ‘« Ofertas para Dos</button>
          <button class="category-btn bg-red-600 text-white px-6 py-3 rounded-full font-bold hover:bg-red-700 whitespace-nowrap flex-shrink-0" data-category="ofertas-personales">ğŸ§‘ Ofertas Personales</button>
          <button class="category-btn bg-red-600 text-white px-6 py-3 rounded-full font-bold hover:bg-red-700 whitespace-nowrap flex-shrink-0" data-category="platos-extras">ğŸ½ï¸ Platos Extras</button>
          <button class="category-btn bg-red-600 text-white px-6 py-3 rounded-full font-bold hover:bg-red-700 whitespace-nowrap flex-shrink-0" data-category="agregados">â• Agregados</button>
        </div>
      </div>
      <div id="products-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl-grid-cols-4 gap-6"></div>
    </div>
  </section>

  <!-- Carrito flotante -->
  <div id="floating-cart" class="floating-cart bg-red-600 text-white px-6 py-4 rounded-full cursor-pointer hover:bg-red-700 transition">
    <div class="flex items-center gap-3">
      <span class="text-2xl">ğŸ›’</span>
      <div>
        <div class="font-bold">Mi Carrito</div>
        <div class="text-sm"><span id="floating-cart-count">0</span> productos - <span id="floating-cart-total">$0</span></div>
      </div>
      <span id="floating-cart-badge" class="cart-badge bg-yellow-400 text-red-900 rounded-full w-8 h-8 flex items-center justify-center text-sm font-bold ml-2">0</span>
    </div>
  </div>

  <!-- Modal opciones -->
  <div id="options-modal" class="modal">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold mb-4 text-red-800">Personaliza tu pedido</h3>

      <!-- Bebidas -->
      <div id="drink-section" class="mb-6 hidden">
        <div class="flex items-center justify-between mb-2">
          <label class="block font-bold text-gray-800 text-sm md:text-base">BEBIDAS â€” <span class="text-gray-600 font-normal">elija su sabor</span></label>
          <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full font-semibold">Obligatorio</span>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg hover:border-red-500 cursor-pointer drink-option-label">
            <input type="radio" name="drink" class="drink-radio" value="Coca Cola"><span class="font-semibold text-gray-800">COCA COLA</span>
          </label>
          <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg hover:border-red-500 cursor-pointer drink-option-label">
            <input type="radio" name="drink" class="drink-radio" value="Inca Kola"><span class="font-semibold text-gray-800">INCA KOLA</span>
          </label>
          <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg hover:border-red-500 cursor-pointer drink-option-label">
            <input type="radio" name="drink" class="drink-radio" value="Coca Cero"><span class="font-semibold text-gray-800">COCA CERO</span>
          </label>
          <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg hover:border-red-500 cursor-pointer drink-option-label">
            <input type="radio" name="drink" class="drink-radio" value="Sprite"><span class="font-semibold text-gray-800">SPRITE</span>
          </label>
          <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg hover:border-red-500 cursor-pointer drink-option-label col-span-2">
            <input type="radio" name="drink" class="drink-radio" value="Fanta"><span class="font-semibold text-gray-800">FANTA</span>
          </label>
        </div>
      </div>

      <!-- Bolsa -->
      <div id="bag-section" class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <label class="block font-bold text-gray-800 text-sm md:text-base">BOLSA ECOLÃ“GICA</label>
          <span id="bag-badge" class="text-xs px-2 py-1 rounded-full font-semibold"></span>
        </div>
        <div id="bag-options" class="grid grid-cols-2 gap-3"></div>
        <p id="bag-note" class="text-xs text-gray-600 mt-3"></p>
      </div>

      <!-- Cantidad -->
      <div class="mb-4">
        <label class="block font-bold mb-2 text-gray-700">Cantidad:</label>
        <div class="flex items-center gap-4">
          <button type="button" id="decrease-quantity" class="w-12 h-12 bg-gray-300 text-gray-700 rounded-full font-bold text-2xl hover:bg-gray-400">-</button>
          <span id="product-quantity" class="text-3xl font-bold text-gray-800 min-w-[60px] text-center">1</span>
          <button type="button" id="increase-quantity" class="w-12 h-12 bg-red-600 text-white rounded-full font-bold text-2xl hover:bg-red-700">+</button>
        </div>
      </div>

      <!-- Total -->
      <div class="mb-6">
        <div class="text-xl font-extrabold text-red-800">Total: <span id="live-total">$0</span></div>
      </div>

      <div class="flex gap-3">
        <button id="cancel-options" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-400">Cancelar</button>
        <button id="confirm-add" class="flex-1 bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700">Agregar al Carrito</button>
      </div>
    </div>
  </div>

  <!-- Modal carrito -->
  <div id="cart-modal" class="modal">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 my-8">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-red-800">ğŸ›’ Tu Carrito</h3>
        <button id="close-cart" class="text-gray-500 hover:text-gray-700 text-3xl">Ã—</button>
      </div>
      <div id="cart-items" class="mb-6 max-h-96 overflow-y-auto"></div>
      <div class="border-t-2 pt-4 mb-6">
        <div class="flex justify-between items-center text-xl font-bold text-red-800"><span>Total:</span><span id="cart-total">$0</span></div>
      </div>
      <button id="checkout-btn" class="w-full bg-green-600 text-white px-6 py-4 rounded-lg font-bold text-lg hover:bg-green-700">ğŸ’¬ Realizar Pedido por WhatsApp</button>
    </div>
  </div>

  <!-- Modal checkout -->
  <div id="checkout-modal" class="modal">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-2xl font-bold mb-4 text-red-800">ğŸ“ Datos de Entrega</h3>
      <form id="checkout-form">
        <div class="mb-4">
          <label class="block font-bold mb-2 text-gray-700">Nombre Completo:</label>
          <input type="text" id="customer-name" required class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-red-500 focus:outline-none" placeholder="Ej: Juan PÃ©rez">
        </div>
        <div class="mb-4">
          <label class="block font-bold mb-2 text-gray-700">DirecciÃ³n de Entrega:</label>
          <textarea id="customer-address" required class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-red-500 focus:outline-none" rows="3" placeholder="Ej: Av. Principal 123, Iquique"></textarea>
        </div>
        <div class="mb-6">
          <label class="block font-bold mb-2 text-gray-700">NÃºmero de TelÃ©fono:</label>
          <input type="tel" id="customer-phone" required class="w-full border-2 border-gray-300 rounded-lg p-3 focus:border-red-500 focus:outline-none" placeholder="+56 9 8692 5310">
        </div>
        <div class="flex gap-3">
          <button type="button" id="cancel-checkout" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg font-bold hover:bg-gray-400">Cancelar</button>
          <button type="submit" class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700">ğŸ“¤ Enviar Mi Pedido</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Asistente virtual tipo chatbot -->
  <div id="chatbot-toggle" class="chatbot-toggle">
    <span>ğŸŸ¢</span><span>WhatsApp / Ayuda</span>
  </div>

  <div id="chatbot-panel" class="chatbot-panel hidden">
    <div class="chatbot-header">
      <div class="chatbot-header-left">
        <div class="chatbot-avatar">ğŸŸ¢</div>
        <div>
          <div class="text-xs opacity-80">Asistente virtual</div>
          <div class="text-sm font-semibold">El PollÃ³n Iquique</div>
        </div>
      </div>
      <button id="chatbot-close" class="text-white text-lg leading-none">&times;</button>
    </div>
    <div id="chatbot-messages" class="chatbot-body flex flex-col"></div>
    <div class="chatbot-quick-actions">
      <button class="chatbot-chip" data-action="familiares">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Combos Familiares</button>
      <button class="chatbot-chip" data-action="horarios">ğŸ• Horarios y direcciÃ³n</button>
      <button class="chatbot-chip" data-action="delivery">ğŸšš Delivery y zonas</button>
      <button class="chatbot-chip" data-action="pedido">ğŸ’¬ Hacer un pedido</button>
      <button class="chatbot-chip" data-action="pagos">ğŸ’³ MÃ©todos de pago</button>
      <button class="chatbot-chip" data-action="redes">ğŸ“² Redes sociales</button>
    </div>
  </div>

  <!-- Modal login Admin -->
  <div id="admin-login-modal" class="modal">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
      <h3 class="text-xl font-bold mb-2 text-gray-900 flex items-center gap-2">
        <span>ğŸ”</span><span>Acceso AdministraciÃ³n</span>
      </h3>
      <p class="text-sm text-gray-600 mb-4">
        Panel privado para gestiÃ³n de pedidos de <strong>PollerÃ­a El PollÃ³n</strong>.
      </p>
      <label class="block text-sm font-semibold text-gray-700 mb-2">ContraseÃ±a de acceso</label>
      <input type="password" id="admin-password" class="w-full border-2 border-gray-300 rounded-lg p-2 mb-3 focus:outline-none focus:border-red-500" placeholder="Ingresa la contraseÃ±a">
      <p id="admin-login-error" class="text-xs text-red-600 mb-3 hidden">ContraseÃ±a incorrecta. Intente nuevamente.</p>
      <div class="flex gap-3">
        <button id="admin-login-cancel" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancelar</button>
        <button id="admin-login-submit" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700">Ingresar</button>
      </div>
    </div>
  </div>

  <!-- Modal Panel Admin -->
  <div id="admin-panel-modal" class="modal">
    <div class="bg-white rounded-lg p-6 max-w-5xl w-full mx-4 my-8">
      <div class="flex justify-between items-start mb-4 gap-4 flex-wrap">
        <div>
          <h3 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <span>ğŸ“Š</span><span>Panel de AdministraciÃ³n</span>
          </h3>
          <p class="text-sm text-gray-600">
            GestiÃ³n de pedidos recibidos desde la carta digital y WhatsApp.
          </p>
        </div>
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <span class="admin-badge admin-badge-pendiente">Pendiente</span>
          <span class="admin-badge admin-badge-preparacion">En preparaciÃ³n</span>
          <span class="admin-badge admin-badge-entregado">Entregado</span>
          <span class="admin-badge admin-badge-cancelado">Cancelado</span>
        </div>
      </div>

      <!-- Stats fila 1 -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
        <div class="admin-stat-card">
          <div class="admin-stat-label">Total pedidos</div>
          <div id="admin-stat-total" class="admin-stat-value">0</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-label">Pedidos hoy</div>
          <div id="admin-stat-hoy" class="admin-stat-value">0</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-label">Ventas hoy</div>
          <div id="admin-stat-ventas-hoy" class="admin-stat-value">$0</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-label">Pendientes</div>
          <div id="admin-stat-pendientes" class="admin-stat-value">0</div>
        </div>
      </div>

      <!-- Stats fila 2 extra -->
      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
        <div class="admin-stat-card">
          <div class="admin-stat-label">% pedidos entregados</div>
          <div id="admin-stat-entregados-pct" class="admin-stat-value">0%</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-label">Ticket promedio</div>
          <div id="admin-stat-ticket-promedio" class="admin-stat-value">$0</div>
        </div>
        <div class="admin-stat-card">
          <div class="admin-stat-label">Tiempo prom. entrega</div>
          <div id="admin-stat-tiempo-prom" class="admin-stat-value">0 min</div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="mt-4 mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs md:text-sm">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-3">
          <div>
            <label class="block font-semibold text-gray-700 mb-1">Desde</label>
            <input type="date" id="admin-filter-from" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs md:text-sm">
          </div>
          <div>
            <label class="block font-semibold text-gray-700 mb-1">Hasta</label>
            <input type="date" id="admin-filter-to" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs md:text-sm">
          </div>
          <div>
            <label class="block font-semibold text-gray-700 mb-1">Estado</label>
            <select id="admin-filter-status" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs md:text-sm">
              <option value="todos">Todos</option>
              <option value="Pendiente">Pendiente</option>
              <option value="En preparaciÃ³n">En preparaciÃ³n</option>
              <option value="Entregado">Entregado</option>
              <option value="Cancelado">Cancelado</option>
            </select>
          </div>
          <div>
            <label class="block font-semibold text-gray-700 mb-1">Buscar (nombre / telÃ©fono)</label>
            <input type="text" id="admin-filter-search" class="w-full border border-gray-300 rounded-md px-2 py-1 text-xs md:text-sm" placeholder="Ej: Juan, +569...">
          </div>
        </div>
        <div class="flex flex-wrap gap-2 justify-between items-center">
          <div class="text-[11px] text-gray-600">
            Pedidos en el rango seleccionado: <span id="admin-filter-count" class="font-semibold">0</span>
          </div>
          <div class="flex flex-wrap gap-2">
            <button id="admin-copy" class="px-3 py-1 rounded-md bg-emerald-100 text-emerald-800 hover:bg-emerald-200 font-semibold text-[11px] md:text-xs">ğŸ“‹ Copiar pedidos (Excel)</button>
            <button id="admin-refresh" class="px-3 py-1 rounded-md bg-sky-100 text-sky-800 hover:bg-sky-200 font-semibold text-[11px] md:text-xs">ğŸ”ƒ Actualizar</button>
            <button id="admin-filter-clear" class="px-3 py-1 rounded-md bg-gray-200 text-gray-800 hover:bg-gray-300 font-semibold text-[11px] md:text-xs">âœ– Limpiar filtros</button>
          </div>
        </div>
      </div>

      <!-- Tabla -->
      <div class="border border-gray-200 rounded-lg overflow-hidden max-h-80 overflow-y-auto text-sm">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">ID</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Cliente</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">TelÃ©fono</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Total</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Estado</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Fecha/Hora</th>
              <th class="px-3 py-2 text-left text-xs font-semibold text-gray-600">Acciones</th>
            </tr>
          </thead>
          <tbody id="admin-orders-body" class="bg-white divide-y divide-gray-100">
          </tbody>
        </table>
      </div>

      <div class="flex justify-end mt-4">
        <button id="admin-close" class="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-900">Cerrar panel</button>
      </div>
    </div>
  </div>

  <!-- UbicaciÃ³n -->
  <section class="py-12 px-4 bg-gray-100">
    <div class="max-w-7xl mx-auto">
      <h2 class="text-4xl font-bold text-center mb-8 text-red-800">ğŸ“ Nuestra UbicaciÃ³n</h2>
      <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3747.8!2d-70.1502!3d-20.2141!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2zMjDCsDEyJzUwLjgiUyA3MMKwMDknMDAuNyJX!5e0!3m2!1ses!2scl!4v1234567890" width="100%" height="450" style="border:0" allowfullscreen loading="lazy"></iframe>
        <div class="p-6 bg-red-600 text-white">
          <h3 class="text-2xl font-bold mb-2">ğŸª PollerÃ­a El PollÃ³n</h3>
          <p class="text-lg">ğŸ“ Calle Vivar 1086, Iquique, Chile</p>
          <p class="text-lg mt-2">ğŸ“ +56 9 8692 5310</p>
          <p class="text-lg mt-2">ğŸ• Horario: Lunes a Domingo 11:30 - 23:00</p>
        </div>
      </div>
    </div>
  </section>

  <!-- SecciÃ³n AdministraciÃ³n visible al final -->
  <section class="py-10 px-4 bg-gray-900">
    <div class="max-w-7xl mx-auto">
      <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 text-white">
        <h2 class="text-2xl font-bold mb-2 flex items-center gap-2">
          <span>ğŸ› ï¸</span><span>AdministraciÃ³n</span>
        </h2>
        <p class="text-sm text-gray-300 mb-4">
          Panel interno para ver, filtrar, copiar e imprimir los pedidos de la carta digital. Solo uso del equipo de PollerÃ­a El PollÃ³n.
        </p>
        <!-- BotÃ³n Admin (estÃ¡tico) -->
        <button id="admin-open-btn" class="hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center gap-2">
          <span>ğŸ”</span><span>Admin</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 px-4">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-8">
        <div>
          <h3 class="text-xl font-bold mb-4 text-yellow-400">Contacto</h3>
          <p class="mb-2">ğŸ“ +56 9 8692 5310</p>
          <p class="mb-2">ğŸ“§ contacto@elpollon.cl</p>
          <p class="mb-2">ğŸ“ Calle Vivar 1086, Iquique</p>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4 text-yellow-400">InformaciÃ³n Legal</h3>
          <ul class="space-y-2">
            <li><a href="#" class="hover:text-yellow-400 transition">ğŸ“‹ Libro de Reclamaciones</a></li>
            <li><a href="#" class="hover:text-yellow-400 transition">ğŸ”’ PolÃ­tica de Privacidad</a></li>
            <li><a href="#" class="hover:text-yellow-400 transition">ğŸ“œ TÃ©rminos y Condiciones</a></li>
          </ul>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4 text-yellow-400">MÃ©todo de Pago</h3>
          <div class="flex items-center gap-3 bg-green-600 px-4 py-3 rounded-lg">
            <span>ğŸ’µ</span>
            <div>
              <p class="font-bold text-lg">Solo Efectivo</p>
              <p class="text-sm opacity-90">Pago contra entrega</p>
            </div>
          </div>
        </div>
        <div>
          <h3 class="text-xl font-bold mb-4 text-yellow-400">SÃ­guenos</h3>
          <div class="flex flex-col gap-3">
            <a href="https://wa.me/56968788613" target="_blank" class="flex items-center gap-3 bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700 transition">ğŸŸ¢ <span class="font-bold">WhatsApp</span></a>
            <a href="#" class="flex items-center gap-3 bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 transition">ğŸ“˜ <span class="font-bold">Facebook</span></a>
            <a href="#" class="flex items-center gap-3 bg-gradient-to-r from-purple-600 to-pink-600 px-4 py-2 rounded-lg hover:from-purple-700 hover:to-pink-700 transition">ğŸ“¸ <span class="font-bold">Instagram</span></a>
            <a href="#" class="flex items-center gap-3 bg-black px-4 py-2 rounded-lg hover:bg-gray-800 transition">ğŸµ <span class="font-bold">TikTok</span></a>
          </div>
        </div>
      </div>
      <div class="border-t border-gray-700 pt-8 text-center">
        <p class="text-gray-400">Â© 2024 PollerÃ­a El PollÃ³n - Iquique, Chile. Todos los derechos reservados.</p>
        <p class="text-gray-500 text-sm mt-2">Desarrollado con â¤ï¸ para los amantes del buen pollo a la brasa</p>
      </div>
    </div>
  </footer>

  <script>
    // --------- Config ----------

    const CURRENCY = new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });
    const BAG_PRICE = 200; // CLP
    const WHATSAPP_NUMBER = '56986925310';

    // ======================= FIREBASE CONFIGURACIÃ“N =========================
    // IMPORTANTE:
    // 1) Entra a https://console.firebase.google.com
    // 2) Crea un proyecto Web y activa "Cloud Firestore"
    // 3) Copia la configuraciÃ³n de tu app web y reemplaza los valores de abajo
    // 4) En Firestore crea una colecciÃ³n llamada: pollon_orders_v1
    // -----------------------------------------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCkFuQQGrIwxI4ln3t8Ap7wuGUW2VixJL0",
      authDomain: "polleria-el-pollon.firebaseapp.com",
      databaseURL: "https://polleria-el-pollon-default-rtdb.firebaseio.com", // no se usa, pero no molesta
      projectId: "polleria-el-pollon",
      storageBucket: "polleria-el-pollon.firebasestorage.app",
      messagingSenderId: "421303971066",
      appId: "1:421303971066:web:f0adeac505350cfc41ed43",
      measurementId: "G-NRMKTLE3EZ"
    };

    let ordersRef = null; // referencia a la colecciÃ³n de Firestore
    let db = null;        // referencia a Firestore
    const ORDERS_PATH = 'pollon_orders_v1'; // nombre de la colecciÃ³n en Firestore

    // Base de datos de pedidos (en memoria, sincronizada con Firestore)
    let orders = [];
    const ORDERS_KEY = 'pollon_orders_v1'; // respaldo local

    // Inicializa Firestore y suscripciÃ³n en tiempo real
    function initOrdersBackend(){
      try{
        if(typeof firebase !== 'undefined' && !firebase.apps.length){
          firebase.initializeApp(firebaseConfig);
        }
        if(typeof firebase !== 'undefined'){
          db = firebase.firestore();
          ordersRef = db.collection(ORDERS_PATH);

          // SuscripciÃ³n en tiempo real a la colecciÃ³n (ordenada por fecha)
          ordersRef.orderBy('createdAt', 'asc').onSnapshot(snapshot => {
            const list = [];
            snapshot.forEach(doc => {
              const data = doc.data() || {};
              list.push({
                id: doc.id,
                ...data
              });
            });
            orders = list;
            // Aseguramos orden por fecha por si acaso
            orders.sort((a,b)=>(a.createdAt||'').localeCompare(b.createdAt||''));
            const adminVisible = document.getElementById('admin-panel-modal')?.classList.contains('active');
            if(adminVisible){
              renderAdminPanel();
            }
          });
        }
      }catch(e){
        console.warn('No se pudo inicializar Firebase/Firestore. Se usarÃ¡ solo almacenamiento local.', e);
      }
    }

    // Guarda el array completo de pedidos (Firestore + respaldo local)
    function saveOrders(){
      if(ordersRef && db){
        // Usamos un batch para escribir todos los pedidos
        const batch = db.batch();
        orders.forEach(o => {
          // Garantizamos que tenga un ID
          if(!o.id){
            o.id = 'P' + Date.now();
          }
          const docRef = ordersRef.doc(o.id);
          batch.set(docRef, o, { merge:true });
        });
        batch.commit().catch(err=>{
          console.error('Error guardando pedidos en Firestore', err);
        });
      }else{
        // Respaldo local si no hay Firebase/Firestore
        try{
          localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
        }catch(e){
          console.error('Error guardando pedidos en localStorage', e);
        }
      }
    }

    // Cargar pedidos (si no hay Firestore, usamos respaldo local)
    function loadOrders(){
      if(ordersRef && db){
        // Con Firestore, la suscripciÃ³n onSnapshot ya los carga en "orders"
        return;
      }else{
        try{
          const raw = localStorage.getItem(ORDERS_KEY);
          orders = raw ? JSON.parse(raw) : [];
        }catch(e){
          orders = [];
        }
      }
    }
    // ===================== FIN CONFIG FIREBASE / BACKEND ====================

    const products = {
      "ofertas-familiares": [
        { name: "Oferton mas chaufa", description: "Pollo entero, papas fritas, arroz chaufa, ensalada y bebidas 1.5lt.", price: 24500, image: "img/oferton mas chaufa.png" },
        { name: "Oferton mas fideo", description: "Pollo entero, papas fritas, fideos al pesto, ensalada y bebidas 1.5lt.", price: 24500, image: "img/oferton mas fideo.png" },
        { name: "Oferton mas chaufa pura papa", description: "Pollo entero, papas fritas, extra papa frita, arroz chaufa y bebidas 1.5lt.", price: 24500, image: "img/oferton mas chaufa pura papa.png" },
        { name: "Oferton con fideo", description: "Pollo entero, papas fritas, fideos al pesto y bebidas 1.5lt", price: 23500, image:"img/oferton con fideo.png" },
        { name: "Oferton sin ensalada", description: "Pollo entero, papas fritas, arroz chaufa y bebidas 1.5lt", price: 23500, image: "img/oferton sin ensalada.png" },
        { name: "Oferton pura papa", description: "Pollo entero, papas fritas, 1/2 porcion de papa frita y bebidas 1.5lt", price: 23500, image: "img/oferton pura papa.png" },
        { name: "ofeton familiar", description: "Pollo entero, papas fritas, ensalada y bebidas 1.5lt", price: 22500, image: "img/oferton familiar.png" },
        { name: "Mega Familiar", description: "2 pollos, papas XXL, ensalada, cremas y 8 bebidas", price: 22500, image:"img/oferton familiar.png" }
      ],
      "ofertas-dos": [
        { name: "1/2 combo chaufa", description: "Medio pollo, papas fritas, arroz chaufa", price: 15100, image: "img/medio combo chaufa.png" },
        { name: "1/2 combo", description: "Medio pollo, papas fritas, ensalada personal", price: 15100, image: "img/medio combo.png" },
        { name: "1/2 combo pura papa", description: "Medio pollo, papas fritas mas cantidad,", price: 15100, image: "img/medio combo pura papa.png" }
      ],
      "ofertas-personales": [
        { name: "1/4 combo", description: "1/4 pollo, papas fritas personales, ensalada personal", price: 8100, image: "img/personal combo.png" },
        { name: "1/4 combo pura papa", description: "1/4 pollo, papas fritas personales mas cantidad, ensalada personal", price: 8100, image: "img/personal pura papa.png" },
        { name: "Chaufa brasa", description: "1/4 pollo, arroz chaufa", price: 8200, image: "img/chaufa brasa.png" },
        { name: "Fideo al pesto con 1/4 de pollo", description: "1/4 pollo, fideos al pesto", price: 8100, image: "img/personal pesto con pollo.png" },
        { name: "Chaufa brasa con papas fritas", description: "1/4 pollo, papas fritas personal, arroz chaufa", price: 9200, image: "img/chaufa brasa con papas fritas.png" }
      ],
      "platos-extras": [
        { name: "Lomo saltado con chaufa", description: "", price: 12200, image: "img/lomo saltado con chaufa.png" },
        { name: "Lomo saltado de carne con arroz blanco ", description: "", price: 11700, image: "" },
        { name: "Lomo saltado de pollo con arroz blanco", description: "", price: 11700, image: "img/lomo saltado de pollo con arroz blanco.png" },
        { name: "Tallarin saltado", description: "", price: 11700, image: "img/tallarin saltado de carne.png" },
        { name: "Bistec a lo pobre", description: "", price: 10700, image: "img/bistec a lo pobre.png" },
        { name: "Bistec con fideos al pesto", description: "", price: 10700, image: "" },
        { name: "Chuleta de cerdo", description: "", price: 10700, image: "img/chuleta de cerdo.png" },
        { name: "Pechuga a la plancha", description: "", price: 10200, image: "img/pechuga a la plancha.png" },
        { name: "Combo nuggets", description: "", price: 6700, image: "" },
        { name: "Salchipapas", description: "Lomo saltado con papas y arroz", price: 6700, image: "https://images.unsplash.com/photo-1595295333158-4742f28fbd85?w=400&h=300&fit=crop" }
      ],
      "agregados": [
        { name: "1 Pollo entero solo", description: "1 pollo entero", price: 15000, image: "img/pollo solo.png" },
        { name: "1/2 Pollo solo", description: " 1/2 pollo  -  parte truto y pechuga", price: 9900, image: "img/medio pollo solo.png" },
        { name: "1/4 pollo solo", description: "1/4 de polo -- truto o pechuga ---segun el stock", price: 5800, image: "" },
        { name: "Porcion de papas fritas familiar", description: "PorciÃ³n grande de papas crujientes", price: 9000, image: "img/porcion de papa.png" },
        { name: "1/2 porcion de papas fritas", description: "Media PorciÃ³n  de papas crujientes", price: 6100, image: "" },
        { name: "Porcion de arroz chaufa", description: "1 PorciÃ³n de arroz chaufa", price: 5300, image: "" },
        { name: "Porcion de fideos al pesto", description: "1 PorciÃ³n de fideos al pesto", price: 5300, image: "img/porcion de fideo.png" },
        { name: "Porcion de ensalada familiar", description: "Ensalada surtida - familiar ", price: 5400, image: "" },
        { name: "Porcion de ensalada personal", description: "Ensalada surtida - personal", price: 3700, image: "" }
      ]
    };

    // --------- Estado ----------
    let cart = [];
    let currentProduct = null;
    let currentCategory = "ofertas-familiares";
    let selectedDrink = null;
    let productQuantity = 1;
    let bagChoice = null;

    // Admin
    let isAdminAuthenticated = false;
    let adminFilters = { from:'', to:'', status:'todos', search:'' };

    // --------- Util ----------
    function money(v){ return CURRENCY.format(v); }
    function showToast(msg){
      const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
      document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
    }

    // ======== TEXTO WHATSAPP (USADO TAMBIÃ‰N PARA IMPRESORA TÃ‰RMICA) ========
    function buildWhatsappTextFromOrder(order){
      const { customer, items, total } = order;
      let msg = `*ğŸ— NUEVO PEDIDO - POLLERÃA EL POLLÃ“N ğŸ—*\n\n`;
      msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*ğŸ“‹ DATOS DEL CLIENTE*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      msg += `ğŸ‘¤ *Nombre:* ${customer.name}\n`;
      msg += `ğŸ“± *TelÃ©fono:* ${customer.phone}\n`;
      msg += `ğŸ“ *DirecciÃ³n:* ${customer.address}\n\n`;
      msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*ğŸ›’ DETALLE DEL PEDIDO*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;

      items.forEach((it,i)=>{
        msg += `*${i+1}. ${it.name}* Ã— ${it.qty}\n`;
        msg += `   ğŸ’° Subtotal: ${money(it.total)}\n`;
        if(it.drink){
          msg += `   ğŸ¥¤ Bebida: ${it.drink}\n`;
        }
        if(it.bagQty>0){
          msg += `   â™»ï¸ Bolsa: x ${it.bagQty} (+ ${money(BAG_PRICE)} c/u)\n`;
        }
        msg += `\n`;
      });

      msg += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n*ğŸ’µ TOTAL A PAGAR: ${money(total)}*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
      msg += `âš ï¸ *EL delivery tiene costo adicional*\n`;
      msg += `ğŸ“ *segun la distancia- $2.500 a $4.000*`;

      return msg;
    }

    // --------- Render products ----------
    function renderProducts(category){
      currentCategory = category;
      const container = document.getElementById('products-container');
      if(!container) return;
      container.innerHTML = '';
      (products[category]||[]).forEach(p=>{
        const card=document.createElement('div');
        card.className='product-card bg-white rounded-lg shadow-lg overflow-hidden';
        card.innerHTML = `
          <img src="${p.image}" alt="${p.name}" class="product-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
          <div class="h-48 bg-gradient-to-br from-orange-400 to-red-500 hidden items-center justify-center text-6xl">ğŸ—</div>
          <div class="p-4">
            <h3 class="font-bold text-lg mb-2 text-red-900">${p.name}</h3>
            <p class="text-gray-600 text-sm mb-3">${p.description}</p>
            <div class="flex justify-between items-center">
              <span class="text-2xl font-bold text-red-700">${money(p.price)}</span>
              <button class="add-to-cart px-4 py-2 rounded-lg font-bold text-white hover:opacity-90" style="background-color:#dc2626" data-product='${JSON.stringify(p)}'>Agregar</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

      document.querySelectorAll('.category-btn').forEach(btn=>{
        btn.style.backgroundColor = btn.dataset.category===category ? '#dc2626' : '#6b7280';
      });
    }

    // --------- Carrito UI ----------
    function updateCartUI(){
      const c = cart.length;
      const total = cart.reduce((s,i)=>s+i.total,0);
      const fc=document.getElementById('floating-cart-count');
      const fb=document.getElementById('floating-cart-badge');
      const ft=document.getElementById('floating-cart-total');
      const mb=document.getElementById('cart-badge-mobile');
      const db=document.getElementById('cart-badge-desktop');
      if(fc) fc.textContent=c;
      if(fb){ fb.textContent=c; fb.classList.add('cart-badge'); setTimeout(()=>fb.classList.remove('cart-badge'),500); }
      if(ft) ft.textContent=money(total);
      if(mb) mb.textContent=c;
      if(db) db.textContent=c;
    }
    function renderCart(){
      const wrap=document.getElementById('cart-items');
      const t=document.getElementById('cart-total');
      if(!wrap || !t) return;
      if(cart.length===0){ wrap.innerHTML='<p class="text-center text-gray-500 py-8">Tu carrito estÃ¡ vacÃ­o</p>'; t.textContent=money(0); return; }
      let total=0;
      wrap.innerHTML = cart.map((it,i)=>{
        total+=it.total;
        const bagLine = it.bagQty>0 ? `â™»ï¸ Bolsa EcolÃ³gica: x ${it.bagQty} (+ ${money(BAG_PRICE)} c/u)` : '';
        const drinkLine = it.drink ? `ğŸ¥¤ Bebida: ${it.drink}` : '';
        return `
          <div class="flex justify-between items-center mb-4 pb-4 border-b">
            <div class="flex-1">
              <h4 class="font-bold text-gray-800">${it.name} Ã— ${it.qty}</h4>
              <p class="text-sm text-gray-600">${drinkLine}</p>
              <p class="text-sm text-green-600">${bagLine}</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-lg text-red-700">${money(it.total)}</p>
              <button class="remove-item text-red-600 text-sm hover:underline" data-index="${i}">Eliminar</button>
            </div>
          </div>`;
      }).join('');
      t.textContent = money(total);
    }

    // --------- Modal helpers ----------
    function setDrinkVisible(visible){
      const s = document.getElementById('drink-section');
      if(s) s.classList.toggle('hidden', !visible);
    }
    function paintBagOptions(){
      const badge = document.getElementById('bag-badge');
      const opts = document.getElementById('bag-options');
      const note = document.getElementById('bag-note');
      if(!badge || !opts || !note) return;

      opts.innerHTML=''; note.textContent=''; bagChoice=null;

      const isFamiliares = currentCategory==='ofertas-familiares';
      const isOtherMandatory = ['ofertas-dos','ofertas-personales','platos-extras'].includes(currentCategory);
      const isAgregados = currentCategory==='agregados';

      if(isFamiliares || isOtherMandatory){
        badge.textContent='Obligatorio';
        badge.className='text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full font-semibold';
        opts.innerHTML = `
          <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg hover:border-red-500 cursor-pointer bag-option">
            <input type="radio" name="bag" value="add" class="bag-radio">
            <span class="font-semibold text-gray-800">Agregar bolsa (+ ${money(BAG_PRICE)})</span>
          </label>
        `;
        note.innerHTML = isFamiliares
          ? `* Esta categorÃ­a requiere agregar bolsa. Costo por bolsa: <strong>${money(BAG_PRICE)}</strong>. Se agregarÃ¡ <strong>1 bolsa por cada unidad</strong>.`
          : `* Esta categorÃ­a requiere agregar bolsa. Costo por bolsa: <strong>${money(BAG_PRICE)}</strong>. Se agregarÃ¡ <strong>1 bolsa por pedido</strong>.`;
      } else if(isAgregados){
        badge.textContent='Opcional';
        badge.className='text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded-full font-semibold';
        opts.innerHTML = `
          <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg hover:border-red-500 cursor-pointer bag-option">
            <input type="radio" name="bag" value="add" class="bag-radio">
            <span class="font-semibold text-gray-800">Agregar bolsa (+ ${money(BAG_PRICE)})</span>
          </label>
          <label class="flex items-center gap-3 p-3 border-2 border-gray-300 rounded-lg hover:border-red-500 cursor-pointer bag-option">
            <input type="radio" name="bag" value="none" class="bag-radio">
            <span class="font-semibold text-gray-800">Sin bolsa</span>
          </label>
        `;
        note.textContent = `* La bolsa es opcional en esta categorÃ­a.`;
      }
    }
    function computeLiveTotal(){
      if(!currentProduct) return { total:0, bagQty:0 };
      const base = currentProduct.price * productQuantity;
      let bagQty = 0;
      if(currentCategory==='ofertas-familiares'){
        bagQty = (bagChoice==='add') ? productQuantity : 0;
      }else if(['ofertas-dos','ofertas-personales','platos-extras'].includes(currentCategory)){
        bagQty = (bagChoice==='add') ? 1 : 0;
      }else if(currentCategory==='agregados'){
        bagQty = (bagChoice==='add') ? 1 : 0;
      }
      const total = base + (bagQty * BAG_PRICE);
      const lt = document.getElementById('live-total');
      if(lt) lt.textContent = money(total);
      return { total, bagQty };
    }

    // --------- ADMIN helpers ----------
    function getTodayString(){
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function filteredOrders(){
      return orders.filter(o=>{
        const d = o.createdAt ? o.createdAt.substring(0,10) : '';
        if(adminFilters.from && d < adminFilters.from) return false;
        if(adminFilters.to && d > adminFilters.to) return false;
        if(adminFilters.status!=='todos' && o.status!==adminFilters.status) return false;
        if(adminFilters.search){
          const term = adminFilters.search.toLowerCase();
          const inName = (o.customer.name || '').toLowerCase().includes(term);
          const inPhone = (o.customer.phone || '').toLowerCase().includes(term);
          if(!inName && !inPhone) return false;
        }
        return true;
      });
    }

    function computeAdminStats(){
      const today = getTodayString();
      const totalPedidos = orders.length;
      const pedidosHoy = orders.filter(o => o.createdAt && o.createdAt.startsWith(today));
      const ventasHoy = pedidosHoy.reduce((s,o)=>s+o.total,0);
      const pendientes = orders.filter(o=>o.status==='Pendiente').length;
      const entregados = orders.filter(o=>o.status==='Entregado');
      const ventasTotales = orders.reduce((s,o)=>s+o.total,0);
      const ticketPromedio = totalPedidos ? (ventasTotales/totalPedidos) : 0;
      const entregadosConTiempo = entregados.filter(o=>o.deliveredAt);
      const promedioMinutos = entregadosConTiempo.length
        ? entregadosConTiempo.reduce((s,o)=>{
            const diff = (new Date(o.deliveredAt) - new Date(o.createdAt))/60000;
            return s + Math.max(diff,0);
          },0) / entregadosConTiempo.length
        : 0;
      const porcentajeEntregados = totalPedidos ? (entregados.length/totalPedidos*100) : 0;

      const elTotal = document.getElementById('admin-stat-total');
      const elHoy = document.getElementById('admin-stat-hoy');
      const elVentas = document.getElementById('admin-stat-ventas-hoy');
      const elPend = document.getElementById('admin-stat-pendientes');
      const elPctEnt = document.getElementById('admin-stat-entregados-pct');
      const elTicket = document.getElementById('admin-stat-ticket-promedio');
      const elTiempo = document.getElementById('admin-stat-tiempo-prom');

      if(elTotal) elTotal.textContent = totalPedidos;
      if(elHoy) elHoy.textContent = pedidosHoy.length;
      if(elVentas) elVentas.textContent = money(ventasHoy);
      if(elPend) elPend.textContent = pendientes;
      if(elPctEnt) elPctEnt.textContent = `${porcentajeEntregados.toFixed(0)}%`;
      if(elTicket) elTicket.textContent = money(ticketPromedio);
      if(elTiempo) elTiempo.textContent = `${promedioMinutos.toFixed(1)} min`;
    }

    function statusBadgeClass(status){
      if(status==='Pendiente') return 'admin-badge admin-badge-pendiente';
      if(status==='En preparaciÃ³n') return 'admin-badge admin-badge-preparacion';
      if(status==='Entregado') return 'admin-badge admin-badge-entregado';
      if(status==='Cancelado') return 'admin-badge admin-badge-cancelado';
      return 'admin-badge';
    }

    function nextStatus(current){
      const order = ['Pendiente','En preparaciÃ³n','Entregado','Cancelado'];
      const idx = order.indexOf(current);
      return order[(idx+1) % order.length];
    }

    function renderAdminPanel(){
      computeAdminStats();
      const tbody = document.getElementById('admin-orders-body');
      const countEl = document.getElementById('admin-filter-count');
      if(!tbody) return;
      const list = filteredOrders();
      if(countEl) countEl.textContent = list.length;
      if(list.length===0){
        tbody.innerHTML = `<tr><td colspan="7" class="px-3 py-4 text-center text-gray-500 text-sm">No hay pedidos con los filtros actuales.</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(o=>{
        const dateStr = o.createdAt ? new Date(o.createdAt).toLocaleString('es-CL') : '';
        return `
          <tr>
            <td class="px-3 py-2 text-xs font-mono text-gray-700">${o.id}</td>
            <td class="px-3 py-2 text-xs text-gray-800">${o.customer.name || '-'}</td>
            <td class="px-3 py-2 text-xs text-gray-700">${o.customer.phone || '-'}</td>
            <td class="px-3 py-2 text-xs font-semibold text-gray-900">${money(o.total)}</td>
            <td class="px-3 py-2 text-xs">
              <span class="${statusBadgeClass(o.status)}">${o.status}</span>
            </td>
            <td class="px-3 py-2 text-xs text-gray-600">${dateStr}</td>
            <td class="px-3 py-2 text-xs">
              <div class="flex flex-wrap gap-1">
                <button class="px-2 py-1 bg-gray-100 text-gray-800 rounded hover:bg-gray-200 admin-view" data-id="${o.id}">Ver</button>
                <button class="px-2 py-1 bg-blue-100 text-blue-800 rounded hover:bg-blue-200 admin-status" data-id="${o.id}">Estado</button>
                <button class="px-2 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200 admin-wa" data-id="${o.id}">WhatsApp</button>
                <button class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded hover:bg-yellow-200 admin-print" data-id="${o.id}">ğŸ–¨ï¸ Imprimir</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function openAdminPanelModal(){
      const modal = document.getElementById('admin-panel-modal');
      if(modal){
        const today = getTodayString();
        if(!adminFilters.from && !adminFilters.to){
          adminFilters.from = today;
          adminFilters.to = today;
        }
        const fromInput = document.getElementById('admin-filter-from');
        const toInput = document.getElementById('admin-filter-to');
        if(fromInput) fromInput.value = adminFilters.from;
        if(toInput) toInput.value = adminFilters.to;
        renderAdminPanel();
        modal.classList.add('active');
      }
    }
    function closeAdminPanelModal(){
      const modal = document.getElementById('admin-panel-modal');
      if(modal) modal.classList.remove('active');
    }

    // ======== IMPRESIÃ“N TÃ‰RMICA: MISMO TEXTO QUE WHATSAPP ========
    function printOrderTicket(order){
      const contenido = buildWhatsappTextFromOrder(order);

      const win = window.open('', '_blank', 'width=400,height=600');
      if(!win) return;
      win.document.write(`
        <html>
          <head>
            <title>Ticket ${order.id}</title>
            <style>
              body{
                font-family:monospace;
                font-size:12px;
                padding:10px;
                white-space:pre;
              }
              @page{
                margin:0;
              }
              @media print{
                body{margin:0;padding:4px;}
              }
            </style>
          </head>
          <body>${contenido}</body>
        </html>
      `);
      win.document.close();
      win.focus();
      win.print();
    }

    // --------- Eventos globales ----------
    document.addEventListener('click', (e)=>{
      // cambiar categorÃ­a
      if(e.target.classList.contains('category-btn') || (e.target.closest && e.target.closest('.category-btn'))){
        const btn = e.target.closest('.category-btn');
        renderProducts(btn.dataset.category);
      }

      // abrir modal opciones
      if(e.target.classList.contains('add-to-cart')){
        currentProduct = JSON.parse(e.target.dataset.product);
        selectedDrink=null; productQuantity=1; bagChoice=null;

        const qEl = document.getElementById('product-quantity');
        if(qEl) qEl.textContent='1';
        document.querySelectorAll('.drink-radio').forEach(r=>r.checked=false);

        setDrinkVisible(currentCategory==='ofertas-familiares');
        paintBagOptions();
        computeLiveTotal();

        const om = document.getElementById('options-modal');
        if(om) om.classList.add('active');
      }

      // seleccionar bebida
      if(e.target.classList.contains('drink-radio')){
        selectedDrink = e.target.value;
      }

      // seleccionar bolsa
      if(e.target.classList.contains('bag-radio')){
        bagChoice = e.target.value;
        computeLiveTotal();
      }

      // qty +
      if(e.target.id==='increase-quantity'){
        productQuantity++; 
        const qEl = document.getElementById('product-quantity');
        if(qEl) qEl.textContent=productQuantity;
        computeLiveTotal();
      }
      // qty -
      if(e.target.id==='decrease-quantity'){
        if(productQuantity>1){ 
          productQuantity--; 
          const qEl = document.getElementById('product-quantity');
          if(qEl) qEl.textContent=productQuantity; 
          computeLiveTotal(); 
        }
      }

      // cancelar opciones
      if(e.target.id==='cancel-options'){
        const om = document.getElementById('options-modal');
        if(om) om.classList.remove('active'); 
        currentProduct=null;
      }

      // confirmar agregar
      if(e.target.id==='confirm-add'){
        if(currentCategory==='ofertas-familiares' && !selectedDrink){
          showToast('âš ï¸ Debes seleccionar un sabor de bebida.');
          return;
        }
        const mustBag = currentCategory!=='agregados';
        if(mustBag && bagChoice!=='add'){
          showToast('âš ï¸ Debes agregar la bolsa (obligatorio).');
          return;
        }
        if(currentCategory==='agregados' && !bagChoice){ bagChoice='none'; }

        const { total, bagQty } = computeLiveTotal();

        cart.push({
          name: currentProduct.name,
          price: currentProduct.price,
          qty: productQuantity,
          drink: currentCategory==='ofertas-familiares' ? selectedDrink : null,
          bagQty,
          total
        });

        updateCartUI();
        showToast('Â¡Producto agregado al carrito!');
        const om = document.getElementById('options-modal');
        if(om) om.classList.remove('active');
        selectedDrink=null; productQuantity=1; bagChoice=null; currentProduct=null;
      }

      // abrir carrito
      if(e.target.id==='floating-cart' || (e.target.closest && e.target.closest('#floating-cart'))){
        renderCart(); 
        const cm = document.getElementById('cart-modal');
        if(cm) cm.classList.add('active');
      }
      if(e.target.id==='close-cart'){ 
        const cm = document.getElementById('cart-modal');
        if(cm) cm.classList.remove('active'); 
      }

      // eliminar item
      if(e.target.classList.contains('remove-item')){
        const idx=parseInt(e.target.dataset.index); 
        cart.splice(idx,1);
        updateCartUI(); 
        renderCart(); 
        showToast('Producto eliminado del carrito');
      }

      // checkout
      if(e.target.id==='checkout-btn'){
        if(cart.length===0){ showToast('Tu carrito estÃ¡ vacÃ­o'); return; }
        const cm = document.getElementById('cart-modal');
        const chm = document.getElementById('checkout-modal');
        if(cm) cm.classList.remove('active');
        if(chm) chm.classList.add('active');
      }
      if(e.target.id==='cancel-checkout'){ 
        const chm = document.getElementById('checkout-modal');
        if(chm) chm.classList.remove('active'); 
      }

      // ADMIN open btn
      if(e.target.id==='admin-open-btn' || (e.target.closest && e.target.closest('#admin-open-btn'))){
        if(!isAdminAuthenticated){
          const lm = document.getElementById('admin-login-modal');
          if(lm) lm.classList.add('active');
          const err = document.getElementById('admin-login-error');
          if(err) err.classList.add('hidden');
        }else{
          openAdminPanelModal();
        }
      }

      // ADMIN login
      if(e.target.id==='admin-login-cancel'){
        const lm = document.getElementById('admin-login-modal');
        if(lm) lm.classList.remove('active');
      }
      if(e.target.id==='admin-login-submit'){
        const passInput = document.getElementById('admin-password');
        const err = document.getElementById('admin-login-error');
        const val = (passInput.value || '').trim();
        if(val==='HUILLCA123'){
          isAdminAuthenticated = true;
          if(err) err.classList.add('hidden');
          const lm = document.getElementById('admin-login-modal');
          if(lm) lm.classList.remove('active');
          showToast('âœ… Acceso concedido al panel de administraciÃ³n.');
          openAdminPanelModal();
        }else{
          if(err) err.classList.remove('hidden');
        }
      }

      // ADMIN close panel
      if(e.target.id==='admin-close'){
        closeAdminPanelModal();
      }

      // ADMIN limpiar filtros
      if(e.target.id==='admin-filter-clear'){
        const ff = document.getElementById('admin-filter-from');
        const ft = document.getElementById('admin-filter-to');
        const fs = document.getElementById('admin-filter-status');
        const fsearch = document.getElementById('admin-filter-search');
        if(ff) ff.value='';
        if(ft) ft.value='';
        if(fs) fs.value='todos';
        if(fsearch) fsearch.value='';
        adminFilters = { from:'', to:'', status:'todos', search:'' };
        renderAdminPanel();
      }

      // ADMIN copiar pedidos
      if(e.target.id==='admin-copy'){
        const list = filteredOrders();
        if(list.length===0){
          showToast('No hay pedidos en el rango seleccionado.');
          return;
        }
        let lines = 'ID\tFecha\tNombre\tTelÃ©fono\tDirecciÃ³n\tTotal\tEstado\n';
        list.forEach(o=>{
          const fecha = o.createdAt ? new Date(o.createdAt).toLocaleString('es-CL') : '';
          const dir = (o.customer.address || '').replace(/\s+/g,' ');
          lines += `${o.id}\t${fecha}\t${o.customer.name || ''}\t${o.customer.phone || ''}\t${dir}\t${o.total}\t${o.status}\n`;
        });
        const copiar = async ()=>{
          try{
            if(navigator.clipboard && navigator.clipboard.writeText){
              await navigator.clipboard.writeText(lines);
            }else{
              throw new Error('no-clipboard');
            }
            showToast('Pedidos copiados. Puedes pegarlos en Excel.');
          }catch{
            const ta=document.createElement('textarea');
            ta.value=lines;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            showToast('Pedidos copiados. Puedes pegarlos en Excel.');
          }
        };
        copiar();
      }

      // ADMIN refresh
      if(e.target.id==='admin-refresh'){
        // Con Firestore se actualiza solo, pero forzamos recÃ¡lculo de estadÃ­sticas y filtros
        loadOrders();
        renderAdminPanel();
        showToast('Panel actualizado (datos en tiempo real).');
      }

      // ADMIN tabla acciones
      if(e.target.classList.contains('admin-view')){
        const id = e.target.dataset.id;
        const order = orders.find(o=>o.id===id);
        if(order){
          const txt = buildWhatsappTextFromOrder(order);
          alert(txt);
        }
      }

      if(e.target.classList.contains('admin-status')){
        const id = e.target.dataset.id;
        const order = orders.find(o=>o.id===id);
        if(order){
          const nuevo = nextStatus(order.status);
          order.status = nuevo;
          if(nuevo === 'Entregado' && !order.deliveredAt){
            order.deliveredAt = new Date().toISOString();
          }
          saveOrders(); // se guarda en Firestore + respaldo local
          renderAdminPanel();
          showToast(`Estado actualizado a: ${nuevo}`);
        }
      }

      if(e.target.classList.contains('admin-wa')){
        const id = e.target.dataset.id;
        const order = orders.find(o=>o.id===id);
        if(order){
          const phoneRaw = (order.customer.phone || '').replace(/\D/g,'');
          const to = phoneRaw || WHATSAPP_NUMBER;
          let msg = `Hola ${order.customer.name || ''}, te escribimos de PollerÃ­a El PollÃ³n respecto a tu pedido ${order.id} (${order.status}).`;
          const url = `https://wa.me/${to}?text=${encodeURIComponent(msg)}`;
          window.open(url,'_blank','noopener,noreferrer');
        }
      }

      if(e.target.classList.contains('admin-print')){
        const id = e.target.dataset.id;
        const order = orders.find(o=>o.id===id);
        if(order){
          printOrderTicket(order);
        }
      }

      // CHATBOT toggle
      if(e.target.id==='chatbot-toggle' || (e.target.closest && e.target.closest('#chatbot-toggle'))){
        const panel = document.getElementById('chatbot-panel');
        if(panel) panel.classList.toggle('hidden');
      }
      if(e.target.id==='chatbot-close'){
        const panel = document.getElementById('chatbot-panel');
        if(panel) panel.classList.add('hidden');
      }

      // CHATBOT chips
      if(e.target.classList.contains('chatbot-chip')){
        const action = e.target.dataset.action;
        handleChatbotAction(action);
      }
    });

    // ADMIN filtros (input)
    document.addEventListener('input', (e)=>{
      if(e.target.id==='admin-filter-from'){
        adminFilters.from = e.target.value || '';
        renderAdminPanel();
      }
      if(e.target.id==='admin-filter-to'){
        adminFilters.to = e.target.value || '';
        renderAdminPanel();
      }
      if(e.target.id==='admin-filter-status'){
        adminFilters.status = e.target.value || 'todos';
        renderAdminPanel();
      }
      if(e.target.id==='admin-filter-search'){
        adminFilters.search = e.target.value || '';
        renderAdminPanel();
      }
    });

    // enviar pedido (checkout)
    const checkoutForm = document.getElementById('checkout-form');
    if(checkoutForm){
      checkoutForm.addEventListener('submit',(e)=>{
        e.preventDefault();
        const name=document.getElementById('customer-name').value.trim();
        const address=document.getElementById('customer-address').value.trim();
        const phone=document.getElementById('customer-phone').value.trim();

        let total=0;
        const itemsForOrder = [];
        cart.forEach((it)=>{
          total += it.total;
          itemsForOrder.push({
            name: it.name,
            qty: it.qty,
            drink: it.drink,
            bagQty: it.bagQty,
            total: it.total
          });
        });

        const order = {
          id: 'P' + Date.now(),
          createdAt: new Date().toISOString(),
          customer: { name, address, phone },
          items: itemsForOrder,
          total,
          status: 'Pendiente',
          deliveredAt: null
        };

        // Guardar pedido en base (Firestore o local)
        orders.push(order);
        saveOrders();

        const rawMsg = buildWhatsappTextFromOrder(order);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(rawMsg)}`;
        window.open(url,'_blank','noopener,noreferrer');

        const adminPanelVisible = document.getElementById('admin-panel-modal')?.classList.contains('active');
        if(adminPanelVisible){
          renderAdminPanel();
        }

        cart=[]; 
        updateCartUI(); 
        const chm = document.getElementById('checkout-modal');
        if(chm) chm.classList.remove('active'); 
        e.target.reset();
        showToast('âœ… Â¡Pedido enviado a WhatsApp y registrado en Firestore!');
      });
    }

    // Sidebar
    const hamburgerBtn=document.getElementById('hamburger-btn');
    const closeSidebar=document.getElementById('close-sidebar');
    const sidebarMenu=document.getElementById('sidebar-menu');
    const sidebarOverlay=document.getElementById('sidebar-overlay');

    function openSidebar(){ 
      if(sidebarMenu) sidebarMenu.style.transform='translateX(0)'; 
      if(sidebarOverlay) sidebarOverlay.classList.remove('hidden'); 
      document.body.style.overflow='hidden'; 
    }
    function closeSidebarMenu(){ 
      if(sidebarMenu) sidebarMenu.style.transform='translateX(-100%)'; 
      if(sidebarOverlay) sidebarOverlay.classList.add('hidden'); 
      document.body.style.overflow='auto'; 
    }
    if(hamburgerBtn) hamburgerBtn.addEventListener('click',openSidebar); 
    if(closeSidebar) closeSidebar.addEventListener('click',closeSidebarMenu); 
    if(sidebarOverlay) sidebarOverlay.addEventListener('click',closeSidebarMenu);

    document.querySelectorAll('.sidebar-category').forEach(btn=>{
      btn.addEventListener('click',()=>{
        renderProducts(btn.dataset.category); 
        closeSidebarMenu(); 
        document.querySelector('#products-container').scrollIntoView({behavior:'smooth',block:'start'}); 
      });
    });
    const viewCartMobile = document.getElementById('view-cart-mobile');
    const viewCartDesktop = document.getElementById('view-cart-desktop');
    if(viewCartMobile){
      viewCartMobile.addEventListener('click',()=>{
        renderCart(); 
        const cm = document.getElementById('cart-modal');
        if(cm) cm.classList.add('active'); 
        closeSidebarMenu(); 
      });
    }
    if(viewCartDesktop){
      viewCartDesktop.addEventListener('click',()=>{
        renderCart(); 
        const cm = document.getElementById('cart-modal');
        if(cm) cm.classList.add('active'); 
      });
    }

    // Carrusel auto
    let currentSlide=0; const totalSlides=10;
    const carouselContainer=document.getElementById('carousel-container');
    function updateCarousel(){ 
      if(carouselContainer) carouselContainer.style.transform=`translateX(-${currentSlide*100}%)`; 
    }
    setInterval(()=>{ 
      currentSlide=(currentSlide+1)%totalSlides; 
      updateCarousel(); 
    },2000);
    updateCarousel();

    // --------- CHATBOT LÃ“GICA ----------
    const chatbotMessagesEl = document.getElementById('chatbot-messages');

    function appendChatbotMessage(text, from='bot'){
      if(!chatbotMessagesEl) return;
      const div = document.createElement('div');
      div.className = 'chatbot-msg ' + (from==='bot' ? 'chatbot-msg-bot' : 'chatbot-msg-user');
      div.innerHTML = text;
      chatbotMessagesEl.appendChild(div);
      chatbotMessagesEl.scrollTop = chatbotMessagesEl.scrollHeight;
    }

    function chatbotWelcome(){
      appendChatbotMessage(`
        ğŸ‘‹ Â¡Bienvenido a <strong>PollerÃ­a El PollÃ³n</strong> en Iquique!<br><br>
        Soy tu asistente virtual tipo <strong>WhatsApp</strong> ğŸ’¬.<br><br>
        Te puedo ayudar con:<br>
        â€¢ Ver combos familiares, para dos y personales ğŸ—<br>
        â€¢ UbicaciÃ³n, horarios y delivery ğŸšš<br>
        â€¢ MÃ©todo de pago y redes sociales ğŸ’³ğŸ“²<br>
        â€¢ Dejar tu pedido listo para WhatsApp âœ…<br><br>
        Elige una opciÃ³n de abajo y te llevo directo donde necesitas.
      `,'bot');
    }

    function handleChatbotAction(action){
      if(action==='familiares'){
        appendChatbotMessage('Quiero ver los combos familiares mÃ¡s pedidos.','user');
        appendChatbotMessage(`
          Excelente elecciÃ³n ğŸ™Œ<br><br>
          Nuestros <strong>Combos Familiares</strong> son los mÃ¡s vendidos del local:<br><br>
          â­ <strong>OfertÃ³n mÃ¡s chaufa</strong>: pollo entero + papas + chaufa + ensalada + bebida 1.5L.<br>
          â­ <strong>OfertÃ³n pura papa</strong>: ideal para los que aman las papas fritas ğŸ¤¤<br>
          â­ <strong>Mega Familiar</strong>: pensado para grupos grandes.<br><br>
          ğŸ‘‰ Te llevo directo a la secciÃ³n de <strong>Ofertas Familiares</strong> para que agregues tu combo al carrito.
        `,'bot');
        const sectionBtn = document.querySelector('.category-btn[data-category="ofertas-familiares"]');
        if(sectionBtn) sectionBtn.click();
        document.querySelector('#products-container')?.scrollIntoView({behavior:'smooth',block:'start'});
      }

      if(action==='horarios'){
        appendChatbotMessage('Quiero saber los horarios y la direcciÃ³n.','user');
        appendChatbotMessage(`
          Perfecto ğŸ•<br><br>
          ğŸ“ <strong>DirecciÃ³n:</strong><br>
          Calle Vivar 1086, Iquique, Chile.<br><br>
          ğŸ• <strong>Horario de atenciÃ³n:</strong><br>
          Lunes a Domingo de <strong>11:30 a 23:00 hrs</strong>.<br><br>
          Puedes venir al local, retirar para llevar o pedir delivery.
        `,'bot');
      }

      if(action==='delivery'){
        appendChatbotMessage('Quiero informaciÃ³n del delivery.','user');
        appendChatbotMessage(`
          Te explico el delivery ğŸšš<br><br>
          â€¢ Repartimos dentro de Iquique ğŸ™ï¸<br>
          â€¢ Costo de envÃ­o segÃºn la zona:<br>
          &nbsp;&nbsp;ğŸ‘‰ Entre <strong>$2.500 y $4.000</strong> aprox.<br><br>
          El valor exacto se confirma por WhatsApp segÃºn tu direcciÃ³n.<br><br>
          Sugerencia: arma tu pedido en la carta y al final lo enviamos directo a WhatsApp âœ…
        `,'bot');
      }

      if(action==='pedido'){
        appendChatbotMessage('Quiero dejar mi pedido listo por WhatsApp.','user');
        appendChatbotMessage(`
          Vamos a dejar tu pedido listo ğŸ˜‹<br><br>
          1ï¸âƒ£ Agrega tus combos y platos al carrito.<br>
          2ï¸âƒ£ Presiona <strong>"Realizar Pedido por WhatsApp"</strong>.<br>
          3ï¸âƒ£ Completa tus datos y confirma.<br><br>
          TambiÃ©n puedes escribirnos directo aquÃ­ ğŸ‘‡<br><br>
          <a href="https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent('Hola, quiero hacer un pedido en PollerÃ­a El PollÃ³n. Â¿Me pueden ayudar con las opciones de combos familiares?')}" target="_blank" class="inline-block bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-semibold">ğŸ’¬ Abrir WhatsApp</a>
        `,'bot');
      }

      if(action==='pagos'){
        appendChatbotMessage('Quiero saber los mÃ©todos de pago.','user');
        appendChatbotMessage(`
          ğŸ’³ <strong>MÃ©todo de pago actual</strong><br><br>
          â€¢ Aceptamos <strong>solo efectivo</strong> en este momento.<br>
          â€¢ El pago se realiza <strong>contra entrega</strong> en el local o al recibir tu pedido a domicilio.<br><br>
          Cualquier cambio futuro en mÃ©todos de pago lo informaremos por nuestras redes sociales.
        `,'bot');
      }

      if(action==='redes'){
        appendChatbotMessage('Quiero ver las redes sociales.','user');
        appendChatbotMessage(`
          ğŸ“² <strong>Nuestras redes sociales</strong><br><br>
          â€¢ WhatsApp: <a href="https://wa.me/56968788613" target="_blank" class="text-green-600 font-semibold">+56 9 6878 8613</a><br>
          â€¢ Facebook: <span class="font-semibold">PollerÃ­a El PollÃ³n (Iquique)</span><br>
          â€¢ Instagram y TikTok: contenido de promociones, combos y novedades ğŸ”¥<br><br>
          Al final de la pÃ¡gina tienes los botones directos a todas las redes.
        `,'bot');
      }
    }

    // --------- Inicio ---------
    initOrdersBackend();   // inicializa Firebase + Firestore + suscripciÃ³n en tiempo real
    loadOrders();          // respaldo local en caso de que falle Firestore
    renderProducts('ofertas-familiares');
    updateCartUI();
    if(chatbotMessagesEl){
      chatbotWelcome();
    }
  </script>
</body>
</html>
